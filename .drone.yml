kind: pipeline
# 使用Docker执行器运行流水线
type: docker
name: default

# 重试以防网络问题导致clone失败
clone:
  retries: 2

trigger:
  branch:
    - main

# 挂载Docker套接字
volumes:
  - name: docker-sock
    host:
      path: /var/run/docker.sock

steps:
  # 编译阶段
  - name: build
    image: node:23
    commands:
      # 配置镜像源
      - npm config set registry https://registry.npmmirror.com
      - yarn config set registry https://registry.npmmirror.com
      - yarn --version ||npm install -g yarn
      - yarn install
      - yarn build
      - ls -la dist || exit 1

  # 部署阶段
  - name: deploy
    image: docker:cli
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      # 复制构建产物到nginx容器
      - docker cp /drone/src/dist my-nginx:/usr/share/nginx/html/
      - docker exec my-nginx nginx -s reload
